<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Estimador CESQ / PSTC</title>
  <style>
    :root { --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa0a6; --card:#171a21; --accent:#6aa6ff; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--fg); }
    .container{ max-width:1100px; margin:32px auto; padding:0 16px; }
    h1{ font-weight:800; margin:0 0 12px; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .card{ background:var(--card); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25); }
    label{ display:block; font-size:.95rem; color:var(--muted); margin-bottom:6px; }
    select, textarea, input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid #2a2f3a; background:#0c0f14; color:#e6e6e6; }
    textarea{ resize:vertical; min-height:140px; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row > *{ flex:1; }
    .actions{ display:flex; gap:10px; justify-content:flex-end; margin-top:12px; }
    button{ background:var(--accent); color:#0b1220; padding:10px 16px; border:none; border-radius:10px; font-weight:700; cursor:pointer; }
    .secondary{ background:#263249; color:#e6e6e6; }
    .pill{ display:inline-block; padding:6px 10px; border-radius:999px; background:#0c1322; border:1px solid #1d2b45; }
    table{ width:100%; border-collapse:collapse; font-size:.95rem; }
    th, td{ border-bottom:1px solid #2a2f3a; padding:8px 6px; text-align:left; vertical-align:top; }
    small, .muted{ color:var(--muted); }
    .kbd{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .ok{ background:#12321f; border:1px solid #1f6b3a; padding:8px 10px; border-radius:10px; }
    .err{ background:#3a1b1b; border:1px solid #6b2a2a; padding:8px 10px; border-radius:10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Estimador CESQ / PSTC</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="grid">
          {% for category, message in messages %}
            <div class="{{ category }} card">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="grid">
      <form method="post" action="{{ url_for('index') }}" class="card">
        <input type="hidden" name="accion" value="estimar" />
        <div class="row">
          <div>
            <label for="tipo">Tipo</label>
            <select id="tipo" name="tipo">
              <option value="desarrollo" {{ 'selected' if form.tipo=='desarrollo' else '' }}>CESQ (desarrollo)</option>
              <option value="implementacion" {{ 'selected' if form.tipo=='implementacion' else '' }}>PSTC (implementación)</option>
            </select>
          </div>
          <div>
            <label for="metodo">Método</label>
            <select id="metodo" name="metodo">
              <option value="softmax" {{ 'selected' if form.metodo=='softmax' else '' }}>Softmax (vecinos)</option>
              <option value="top1" {{ 'selected' if form.metodo=='top1' else '' }}>Top-1</option>
            </select>
          </div>
          <div>
            <label for="origen">Origen</label>
            <select id="origen" name="origen">
              <option value="todos" {{ 'selected' if form.origen=='todos' else '' }}>Todos</option>
              <option value="historic" {{ 'selected' if form.origen=='historic' else '' }}>Histórico</option>
              <option value="catalog" {{ 'selected' if form.origen=='catalog' else '' }}>Catálogo</option>
              <option value="new" {{ 'selected' if form.origen=='new' else '' }}>Nuevos</option>
            </select>
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="texto">Descripción</label>
          <textarea id="texto" name="texto" placeholder="Describe el ticket...">{{ form.texto }}</textarea>
        </div>
        <div class="actions">
          <button type="submit">Estimar</button>
        </div>
      </form>

      <div class="card">
        <h3>Resultado</h3>
        <p>Estimación IA: <span class="pill">{{ '%.2f'|format(estimate) if estimate is not none else '-' }} h</span></p>
        <p>Top-1: <span class="pill">{{ '%.2f'|format(estimate_top1) if estimate_top1 is not none else '-' }} h</span></p>

        {% if examples %}
        <h4>Vecinos (Top 3)</h4>
        <table>
          <thead><tr><th>#</th><th>Ticket</th><th>Horas</th><th>Sim</th><th>Origen</th><th>Texto</th></tr></thead>
          <tbody>
            {% for ex in examples %}
              <tr>
                <td>{{ loop.index }}</td>
                <td class="kbd">{{ ex.ticket }}</td>
                <td>{{ '%.2f'|format(ex.horas) }}</td>
                <td>{{ '%.3f'|format(ex.sim) }}</td>
                <td>{{ ex.source }}</td>
                <td>{{ ex.texto }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% endif %}
      </div>
    </div>

    <form method="post" action="{{ url_for('retrain') }}" style="margin-top:16px;">
      <button type="submit" class="secondary">Reentrenar índices</button>
    </form>

    <div class="card" style="margin-top:16px;">
      <h3>Guardar estimación</h3>
      <form method="post" action="{{ url_for('index') }}">
        <input type="hidden" name="accion" value="guardar" />
        <input type="hidden" name="tipo" value="{{ form.tipo }}" />
        <input type="hidden" name="texto" value="{{ form.texto }}" />
        <input type="hidden" name="metodo_usado" value="{{ form.metodo }}" />
        <div class="row">
          <div>
            <label>Estimación IA</label>
            <input name="estimacion_ia" placeholder="ej: {{ '%.2f'|format(estimate) if estimate is not none else '4.00' }}" />
          </div>
          <div>
            <label>Estimación Top-1</label>
            <input name="estimacion_top1" placeholder="ej: {{ '%.2f'|format(estimate_top1) if estimate_top1 is not none else '4.00' }}" />
          </div>
          <div>
            <label>Estimación final</label>
            <input name="estimacion_final" placeholder="si está vacío se usa IA/Top1" />
          </div>
          <div>
            <label>Horas reales</label>
            <input name="horas_reales" placeholder="opcional" />
          </div>
        </div>
        <div class="actions">
          <button type="submit">Guardar</button>
        </div>
      </form>
      <p class="muted">Se guarda en <span class="kbd">data/estimaciones_nuevas.csv</span> y se usa en futuros reentrenos.</p>
    </div>

    <div class="card" style="margin-top:16px;">
      <h3>Estructura de datos (separados)</h3>
      <ul>
        <li>Catálogo CESQ → <span class="kbd">data/catalogo_cesq.csv</span> (cols: <em>text,hours</em>)</li>
        <li>Catálogo PSTC → <span class="kbd">data/catalogo_pstc.csv</span> (cols: <em>text,hours</em>)</li>
        <li>Históricos nuevos (guardados en la UI) → <span class="kbd">data/estimaciones_nuevas.csv</span></li>
      </ul>
      <small class="muted">Puedes agregar otros CSV históricos con horas y los integramos desde estimator.py.</small>
    </div>
  </div>
</body>
</html>
