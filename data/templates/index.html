
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IA Estimador</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="container">
    <h1>IA Estimador</h1>

    <div class="status">
      <span class="tag">Embeddings: {{ 'ON' if status.emb_enabled else 'OFF' }}</span>
      <span class="tag">KB: {{ status.kb_count }}</span>
      <span class="tag">Emb index: {{ 'OK' if status.emb else '—' }}</span>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-area">
          {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Form de estimación -->
    <form method="post" action="{{ url_for('index') }}" class="card">
      <input type="hidden" name="action" value="estimate" />
      <div class="field">
        <label for="tipo">Tipo de requerimiento</label>
        <select id="tipo" name="tipo">
          <option value="CESQ" {{ 'selected' if form.tipo == 'CESQ' else '' }}>CESQ (desarrollo)</option>
          <option value="PSTC" {{ 'selected' if form.tipo == 'PSTC' else '' }}>PSTC (implementación)</option>
        </select>
      </div>

      <div class="field">
        <label for="descripcion">Descripción</label>
        <textarea id="descripcion" name="descripcion" rows="6" placeholder="Describe el ticket o requerimiento...">{{ form.descripcion }}</textarea>
      </div>

      <div class="actions">
        <button type="submit">Estimar</button>
      </div>
    </form>

    <!-- Acciones de histórico (fuera del form principal para evitar anidación) -->
    <div class="card actions-row">
      <form method="post" action="{{ url_for('retrain_route') }}">
        <button type="submit" class="secondary">Reentrenar histórico</button>
      </form>
      <form method="post" action="{{ url_for('upload_route') }}" enctype="multipart/form-data">
        <input type="file" name="file" accept=".csv" />
        <button type="submit" class="secondary">Subir CSV</button>
      </form>
    </div>

    <div class="results">
      <div>Catálogo base: <span class="pill">{{ estimate_catalog|hfmt }} h</span></div>
      <div>IA similitud: <span class="pill">{{ estimate_semantic|hfmt }} h</span></div>
      <div>IA combinada: <span class="pill">{{ estimate|hfmt }} h</span></div>
    </div>

    {% if kb_hits and kb_hits|length > 0 %}
    <div class="card">
      <h3>Coincidencias del histórico (top {{ top_k }})</h3>
      <table class="tbl">
        <thead>
          <tr><th>#</th><th>ID</th><th>Tipo</th><th>Horas</th><th>Similitud</th><th>Descripción</th></tr>
        </thead>
        <tbody>
          {% for h in kb_hits %}
          <tr>
            <td>{{ loop.index }}</td>
            <td>{{ h.id }}</td>
            <td>{{ h.tipo }}</td>
            <td>{{ h.horas if h.horas is not none else '—' }}</td>
            <td>{{ '{:.3f}'.format(h.sim) if h.sim is defined else '—' }}</td>
            <td class="wrap">{{ h.descripcion[:300] }}{% if h.descripcion|length > 300 %}…{% endif %}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <footer>
      <small>Render-ready • Flask + Gunicorn • Catálogo + Histórico + Reentrenar + Upload</small>
    </footer>
  </div>
</body>
</html>
